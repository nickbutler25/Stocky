name: Run Stocky Tee Times Daily

on:
  schedule:
    - cron: '55 17 * * *'  # Runs at 5:58 PM UTC every day
  workflow_dispatch:  # Allows manual triggering

jobs:
  run-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'


      # Step 2: Install Google Chrome
      - name: Install Google Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb > chrome.deb
          sudo dpkg -i chrome.deb
          sudo apt --fix-broken install -y  # Fix any missing dependencies

      # Step 3: Get Chrome version
      - name: Get Chrome Version
        run: |
          CHROME_VERSION=$(google-chrome --version)
          echo "Chrome Version: $CHROME_VERSION"

      # Step 4: Download ChromeDriver
      - name: Download ChromeDriver
        run: |
          # Print the URL for debugging
          echo "ChromeDriver URL: https://storage.googleapis.com/chrome-for-testing-public/132.0.6834.110/linux64/chromedriver-linux64.zip"

          # Download ChromeDriver without suppressing output for debugging
          wget https://storage.googleapis.com/chrome-for-testing-public/132.0.6834.110/linux64/chromedriver-linux64.zip
          if [ $? -ne 0 ]; then
            echo "Failed to download ChromeDriver"
            exit 1
          fi
          echo "Downloaded chromedriver-linux64.zip"

         # Step 5: List contents of the ChromeDriver ZIP file
      - name: List contents of ChromeDriver ZIP
        run: |
          unzip -l chromedriver-linux64.zip  # List the contents of the zip file

      # Step 6: Unzip ChromeDriver
      - name: Unzip ChromeDriver
        run: |
          unzip chromedriver-linux64.zip -d chromedriver-linux64
          echo "Unzipped chromedriver-linux64.zip"

      # Step 7: List files after unzip
      - name: List contents after unzip
        run: |
          ls -R chromedriver-linux64  # List all files after unzip

      # Step 8: Move ChromeDriver to /usr/local/bin (account for nested directory)
      - name: Move ChromeDriver
        run: |
          if [ ! -f chromedriver-linux64/chromedriver-linux64/chromedriver ]; then
            echo "ChromeDriver binary not found after unzip"
            exit 1
          fi
          sudo mv chromedriver-linux64/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          echo "Moved chromedriver to /usr/local/bin"

      # Step 9: Set executable permissions
      - name: Set executable permissions
        run: |
          sudo chmod +x /usr/local/bin/chromedriver
          if [ $? -ne 0 ]; then
            echo "Failed to set executable permissions"
            exit 1
          fi
          echo "Set executable permissions for chromedriver"

      # Step 10: Verify ChromeDriver installation
      - name: Verify ChromeDriver
        run: |
          chromedriver --version



      #Install required dependencies from requirements file
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # If you have dependencies

      - name: Install Selenium
        run: |
          pip install selenium webdriver-manager --no-deps

      - name: Run Python script
        run: |
          python program.py '{"username": "${{ vars.MAD_AL_USER }}", "password": "${{ secrets.MAD_AL_PASSWORD }}", "time_to_book": "${{ vars.FRIDAY_TIME }}"}'
