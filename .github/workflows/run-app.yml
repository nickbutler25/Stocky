name: Run Stockwood Vale Tee Times Daily - Mad Al

on:
  schedule:
    # Run at 5:00 PM UK time on Thursdays and Fridays
    # Two schedules needed because UK switches between BST (UTC+1) and GMT (UTC+0)
    # BST: Last Sunday in March to last Sunday in October (UTC+1)
    # GMT: Last Sunday in October to last Sunday in March (UTC+0)
    # Starting 1 hour earlier to account for GitHub Actions scheduling delays
    - cron: '0 16 * 4-10 4,5'  # 4:00 PM UTC = 5:00 PM BST (April-October, definitely BST)
    - cron: '0 17 * 11-12,1-2 4,5'  # 5:00 PM UTC = 5:00 PM GMT (November-February, definitely GMT)
    # March is transition month - using BST time (may be 1 hour early on first few Thursdays/Fridays)
    - cron: '0 16 * 3 4,5'  # March: using BST schedule (transition happens late March)
  workflow_dispatch:  # Allows manual triggering

jobs:
  run-app:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'


      # Install Google Chrome
      - name: Install Google Chrome
        run: |
          wget -q -O - https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb > chrome.deb
          sudo dpkg -i chrome.deb
          sudo apt --fix-broken install -y

      # Install Python dependencies (webdriver-manager will handle ChromeDriver automatically)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Wait until 5:58 PM UK time before running the Python script
      - name: Wait until 5:58 PM UK time
        run: |
          # Install TZ data for timezone conversion
          sudo apt-get update -qq && sudo apt-get install -y tzdata

          # Get current time in UK timezone
          export TZ='Europe/London'
          CURRENT_UK_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
          echo "Current UK time: $CURRENT_UK_TIME"

          # Get current time in seconds since epoch
          CURRENT_TIME=$(date +%s)

          # Calculate target time: 5:58 PM UK time (17:58)
          # Note: date command with TZ set will handle BST/GMT automatically
          TARGET_TIME=$(TZ='Europe/London' date -d "today 17:58:00" +%s)

          # If target time is in the past (already passed today), don't wait
          if [ $CURRENT_TIME -gt $TARGET_TIME ]; then
            echo "Current time is after 5:58 PM UK time. Running script immediately."
            exit 0
          fi

          # Calculate wait time in seconds
          WAIT_TIME=$((TARGET_TIME - CURRENT_TIME))
          WAIT_MINUTES=$((WAIT_TIME / 60))

          echo "Target time: 5:58 PM UK (17:58 Europe/London)"
          echo "Waiting for $WAIT_TIME seconds ($WAIT_MINUTES minutes)"

          # Wait until 5:58 PM UK time
          sleep $WAIT_TIME


      # Run Python script
      - name: Run Python script
        run: |
          # Run the second instance of the Python script with the second set of parameters
          python program.py '{"username": "${{ vars.MAD_AL_USER }}", "password": "${{ secrets.MAD_AL_PASSWORD }}", "time_to_book": "${{ vars.SATURDAY_TIME }}"
          , "min_time": "${{ vars.SATURDAY_MIN_TIME }}", "max_time": "${{ vars.SATURDAY_MAX_TIME }}"}'


